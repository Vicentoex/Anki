<!-- Back Template (Reverso) - Compatible PC y Móvil -->
<div style="font-family:Arial; font-size:18px; margin-bottom:15px;">
  {{Anverso}}
</div>

<div id="options-container-back" style="margin:15px 0;"></div>

<hr style="margin: 20px 0;">

<div style="font-family:Arial; font-size:16px; margin-top:10px;">
  <div id="result-message" style="font-size:20px; font-weight:bold; margin:15px 0;"></div>
  <div style="margin-bottom:10px;">
    <span style="font-weight:normal;">Respuesta correcta:</span> 
    <strong id="correct-answer-display" style="color:green;">{{Answer}}</strong>
  </div>
  <div style="margin-top:15px; padding:10px; background-color:rgba(0,0,0,0.03); border-radius:5px;">
    {{Notas}}
  </div>
</div>

<script>
(function() {
  // Misma función para generar la clave única de la pregunta
  function generateQuestionKey(content) {
    let hash = 0;
    for (let i = 0; i < content.length; i++) {
      const char = content.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return 'anki_q_' + Math.abs(hash);
  }
  
  const questionText = `{{Anverso}}`.trim();
  const questionKey = generateQuestionKey(questionText);
  
  // Claves únicas para esta pregunta específica (deben coincidir con el anverso)
  const SHUFFLE_KEY = questionKey + '_shuffle';
  const SELECTION_KEY = questionKey + '_selection';
  
  function showResults() {
    const correctAnswer = `{{Answer}}`.trim();
    const container = document.getElementById('options-container-back');
    const resultMessageEl = document.getElementById('result-message');
    const correctAnswerDisplayEl = document.getElementById('correct-answer-display');
    
    if (!container || !resultMessageEl || !correctAnswerDisplayEl) return;
    
    // Mostrar respuesta correcta
    correctAnswerDisplayEl.textContent = correctAnswer;
    
    // Obtener las opciones barajadas del sessionStorage
    let options;
    try {
      const shuffledData = sessionStorage.getItem(SHUFFLE_KEY);
      if (shuffledData) {
        options = JSON.parse(shuffledData);
      } else {
        // Si no hay datos barajados, usar el orden original
        options = [
          `{{Opción 1}}`.trim(),
          `{{Opción 2}}`.trim(),
          `{{Opción 3}}`.trim()
        ].filter(opt => opt !== '');
      }
    } catch (e) {
      console.error('Error al recuperar opciones:', e);
      options = [
        `{{Opción 1}}`.trim(),
        `{{Opción 2}}`.trim(),
        `{{Opción 3}}`.trim()
      ].filter(opt => opt !== '');
    }
    
    // Obtener la selección del usuario
    const userChoice = sessionStorage.getItem(SELECTION_KEY);
    const hasSelection = !!userChoice;
    const isCorrect = hasSelection && userChoice === correctAnswer;
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    // Mostrar todas las opciones con estilos apropiados
    options.forEach(option => {
      const div = document.createElement('div');
      div.textContent = option;
      div.style.cssText = `
        display: block;
        margin-bottom: 10px;
        padding: 10px;
        border: 2px solid #ccc;
        border-radius: 8px;
        transition: all 0.3s ease;
      `;
      
      // Aplicar estilos según el estado de la opción
      if (option === correctAnswer) {
        // Opción correcta - siempre en verde
        div.style.borderColor = '#28a745';
        div.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
        div.style.fontWeight = 'bold';
        
        // Agregar un checkmark
        const checkmark = document.createElement('span');
        checkmark.textContent = ' ✓';
        checkmark.style.color = '#28a745';
        checkmark.style.fontWeight = 'bold';
        div.appendChild(checkmark);
        
      } else if (hasSelection && option === userChoice) {
        // Opción seleccionada incorrectamente
        div.style.borderColor = '#dc3545';
        div.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
        div.style.textDecoration = 'line-through';
        div.style.opacity = '0.7';
        
        // Agregar una X
        const xmark = document.createElement('span');
        xmark.textContent = ' ✗';
        xmark.style.color = '#dc3545';
        xmark.style.fontWeight = 'bold';
        div.appendChild(xmark);
      }
      
      container.appendChild(div);
    });
    
    // Mostrar mensaje de resultado
    if (!hasSelection) {
      resultMessageEl.textContent = '⚠️ No seleccionaste ninguna opción';
      resultMessageEl.style.color = '#ff9800';
    } else if (isCorrect) {
      resultMessageEl.textContent = '✅ ¡CORRECTO!';
      resultMessageEl.style.color = '#28a745';
    } else {
      resultMessageEl.textContent = '❌ INCORRECTO';
      resultMessageEl.style.color = '#dc3545';
    }
    
    // Limpiar sessionStorage para esta pregunta después de mostrar resultados
    // Esto evita que se acumulen datos de sesiones anteriores
    setTimeout(function() {
      sessionStorage.removeItem(SHUFFLE_KEY);
      sessionStorage.removeItem(SELECTION_KEY);
    }, 100);
  }
  
  // Ejecutar inmediatamente
  showResults();
  
  // Asegurar que se ejecute incluso con diferentes timings
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', showResults);
  } else {
    setTimeout(showResults, 0);
  }
})();
</script>