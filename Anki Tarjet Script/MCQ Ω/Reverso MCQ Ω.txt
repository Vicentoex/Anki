<!-- Front Template (Anverso) - Dise帽o 惟 Optimizado -->
<div class="helper-text">Selecciona tu respuesta</div>

<div class="question-container">
  <div class="question-text">
    {{Anverso}}
  </div>
</div>

<form id="quiz-front">
  <div id="options-container-front" class="options-wrapper">
    <!-- Las opciones se generar谩n din谩micamente -->
  </div>
</form>

<div class="skip-button-container">
  <button type="button" class="skip-button" id="skip-btn">
    <span>し</span> No lo s茅
  </button>
</div>

<div class="keyboard-hint">
  Atajos: <kbd>J</kbd> <kbd>K</kbd> <kbd>L</kbd> para opciones 路 <kbd>N</kbd> para saltar
</div>

<!-- Elemento oculto para obtener el texto de forma segura -->
<div id="anverso-data" style="display:none;">{{Anverso}}</div>
<div id="opcion1-data" style="display:none;">{{Opci贸n 1}}</div>
<div id="opcion2-data" style="display:none;">{{Opci贸n 2}}</div>
<div id="opcion3-data" style="display:none;">{{Opci贸n 3}}</div>
<div id="exp1-data" style="display:none;">{{E 1}}</div>
<div id="exp2-data" style="display:none;">{{E 2}}</div>
<div id="exp3-data" style="display:none;">{{E 3}}</div>

<script>
(function() {
  // Funci贸n para obtener texto de forma segura (evita problemas con backticks)
  function getSafeText(elementId) {
    var el = document.getElementById(elementId);
    return el ? el.textContent.trim() : '';
  }
  
  // Generamos una clave 煤nica basada en el contenido de la pregunta
  function generateQuestionKey(content) {
    var hash = 0;
    for (var i = 0; i < content.length; i++) {
      var char = content.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return 'anki_q_' + Math.abs(hash);
  }
  
  var questionText = getSafeText('anverso-data');
  var questionKey = generateQuestionKey(questionText);
  
  // Claves 煤nicas para esta pregunta espec铆fica
  var SHUFFLE_KEY = questionKey + '_shuffle';
  var SELECTION_KEY = questionKey + '_selection';
  var EXPLANATIONS_KEY = questionKey + '_explanations';
  var SKIPPED_KEY = questionKey + '_skipped';
  
  // Array con las opciones originales y sus explicaciones
  var optionsData = [
    { text: getSafeText('opcion1-data'), explanation: getSafeText('exp1-data') },
    { text: getSafeText('opcion2-data'), explanation: getSafeText('exp2-data') },
    { text: getSafeText('opcion3-data'), explanation: getSafeText('exp3-data') }
  ].filter(function(opt) { return opt.text !== ''; });
  
  // Fisher-Yates para barajar
  function shuffleArray(array) {
    var arr = array.slice();
    for (var i = arr.length - 1; i > 0; i--) {
      var j = Math.floor(Math.random() * (i + 1));
      var temp = arr[i];
      arr[i] = arr[j];
      arr[j] = temp;
    }
    return arr;
  }
  
  // Funci贸n segura para sessionStorage
  function safeSessionSet(key, value) {
    try {
      sessionStorage.setItem(key, value);
    } catch (e) {
      console.log('sessionStorage not available');
    }
  }
  
  function safeSessionGet(key) {
    try {
      return sessionStorage.getItem(key);
    } catch (e) {
      return null;
    }
  }
  
  function safeSessionRemove(key) {
    try {
      sessionStorage.removeItem(key);
    } catch (e) {}
  }
  
  // Funci贸n para mostrar respuesta (compatible con todas las plataformas)
  function showAnswerCard() {
    if (typeof window.showAnswer === 'function') {
      window.showAnswer();
    } else if (typeof pycmd === 'function') {
      pycmd('ans');
    } else if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.cb) {
      window.webkit.messageHandlers.cb.postMessage('ans');
    } else if (typeof AnkiDroidJS !== 'undefined') {
      AnkiDroidJS.ankiShowAnswer();
    }
  }
  
  // Referencias a los inputs para atajos de teclado
  var optionInputs = [];
  
  // Referencia al handler para poder removerlo
  var keyHandler = null;
  
  function generateOptions() {
    var container = document.getElementById('options-container-front');
    if (!container || optionsData.length === 0) return;
    
    // Limpiar selecci贸n previa y skipped
    safeSessionRemove(SELECTION_KEY);
    safeSessionRemove(SKIPPED_KEY);
    
    // Barajar las opciones
    var shuffledOptions = shuffleArray(optionsData);
    
    // Guardar el orden barajado para esta pregunta espec铆fica
    safeSessionSet(SHUFFLE_KEY, JSON.stringify(shuffledOptions.map(function(o) { return o.text; })));
    
    // Guardar el mapeo de explicaciones
    var explanationsMap = {};
    shuffledOptions.forEach(function(opt) {
      explanationsMap[opt.text] = opt.explanation;
    });
    safeSessionSet(EXPLANATIONS_KEY, JSON.stringify(explanationsMap));
    
    // Limpiar contenedor
    container.innerHTML = '';
    optionInputs = [];
    
    // Teclas para atajos (J, K, L)
    var keys = ['J', 'K', 'L'];
    
    // Crear los radio buttons
    shuffledOptions.forEach(function(option, index) {
      var optionDiv = document.createElement('div');
      optionDiv.className = 'option-card';
      
      var label = document.createElement('label');
      label.className = 'option-label';
      
      // Indicador de tecla
      var keyIndicator = document.createElement('span');
      keyIndicator.className = 'option-key';
      keyIndicator.textContent = keys[index] || '';
      
      // Crear el contenedor del radio button
      var radioWrapper = document.createElement('div');
      radioWrapper.className = 'radio-wrapper';
      
      var input = document.createElement('input');
      input.type = 'radio';
      input.name = 'mcq_choice';
      input.value = option.text;
      input.id = 'option_' + index;
      input.className = 'option-input';
      
      // Guardar referencia para atajos
      optionInputs.push(input);
      
      var customRadio = document.createElement('span');
      customRadio.className = 'custom-radio';
      
      var optionText = document.createElement('span');
      optionText.className = 'option-text';
      optionText.textContent = option.text;
      
      // Guardar la selecci贸n cuando cambie
      input.addEventListener('change', function() {
        safeSessionSet(SELECTION_KEY, option.text);
        safeSessionRemove(SKIPPED_KEY);
        
        // Actualizar estilos visuales
        container.querySelectorAll('.option-card').forEach(function(card) {
          card.classList.remove('selected');
        });
        optionDiv.classList.add('selected');
        
        // Vibraci贸n suave en m贸viles
        if (navigator.vibrate) {
          navigator.vibrate(10);
        }
        
        // Remover el listener de teclado antes de cambiar
        if (keyHandler) {
          document.removeEventListener('keydown', keyHandler, true);
        }
        
        // Mostrar respuesta autom谩ticamente
        showAnswerCard();
      });
      
      radioWrapper.appendChild(input);
      radioWrapper.appendChild(customRadio);
      
      label.appendChild(keyIndicator);
      label.appendChild(radioWrapper);
      label.appendChild(optionText);
      
      optionDiv.appendChild(label);
      container.appendChild(optionDiv);
    });
  }
  
  // Bot贸n "No lo s茅"
  function handleSkip() {
    safeSessionRemove(SELECTION_KEY);
    safeSessionSet(SKIPPED_KEY, 'true');
    
    // Vibraci贸n
    if (navigator.vibrate) {
      navigator.vibrate(20);
    }
    
    // Remover el listener de teclado antes de cambiar
    if (keyHandler) {
      document.removeEventListener('keydown', keyHandler, true);
    }
    
    showAnswerCard();
  }
  
  var skipBtn = document.getElementById('skip-btn');
  if (skipBtn) {
    skipBtn.addEventListener('click', handleSkip);
  }
  
  // Atajos de teclado (J, K, L, N) - con capture para interceptar antes que Anki
  keyHandler = function(e) {
    // Ignorar si hay un input de texto activo
    if (e.target.tagName === 'INPUT' && e.target.type === 'text') return;
    if (e.target.tagName === 'TEXTAREA') return;
    
    var key = e.key.toLowerCase();
    
    // Solo interceptar nuestras teclas espec铆ficas
    if (['j', 'k', 'l', 'n'].indexOf(key) === -1) return;
    
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    
    // J, K, L para opciones
    if (key === 'j' && optionInputs[0]) {
      optionInputs[0].checked = true;
      optionInputs[0].dispatchEvent(new Event('change'));
    } else if (key === 'k' && optionInputs[1]) {
      optionInputs[1].checked = true;
      optionInputs[1].dispatchEvent(new Event('change'));
    } else if (key === 'l' && optionInputs[2]) {
      optionInputs[2].checked = true;
      optionInputs[2].dispatchEvent(new Event('change'));
    } else if (key === 'n') {
      // N para "No lo s茅"
      handleSkip();
    }
  };
  
  // Usar capture: true para interceptar antes que Anki
  document.addEventListener('keydown', keyHandler, true);
  
  // Generar opciones inicialmente
  generateOptions();
})();
</script>
